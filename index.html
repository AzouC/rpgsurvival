<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Survival RPG ULTIMATE</title>
<style>
    /* --- CSS GLOBAL --- */
    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
    
    #gameCanvas { display: block; width: 100%; height: 100%; }
    #rotate-msg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; text-align: center; }

    /* --- UI --- */
    .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    
    /* HUD STATS (Haut Gauche) */
    .hud { position: absolute; top: 10px; left: 10px; background: rgba(20,20,20,0.9); color: #fff; padding: 8px; border-radius: 8px; border: 2px solid #555; font-size: 13px; font-weight: bold; display: flex; flex-direction: column; gap: 5px; pointer-events: auto; max-width: 200px; }
    .hud-row { display: flex; justify-content: space-between; gap: 10px; }
    .res-icon { width: 20px; text-align: center; display: inline-block; }

    /* QUEST TRACKER (Haut Droite) */
    .quest-box { position: absolute; top: 10px; right: 70px; background: rgba(0,0,0,0.6); color: #f1c40f; padding: 10px; border-radius: 5px; border-left: 4px solid #f1c40f; font-size: 14px; max-width: 250px; text-align: right; pointer-events: none; }
    .quest-title { font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; color: #aaa; }
    
    /* MINI-MAP (Bas Droite) */
    .minimap-container { position: absolute; bottom: 10px; left: 10px; width: 150px; height: 150px; border: 3px solid #fff; border-radius: 50%; overflow: hidden; background: #000; box-shadow: 0 0 10px #000; pointer-events: auto; opacity: 0.9; }
    #miniCanvas { width: 100%; height: 100%; display: block; }

    /* CONTROLS */
    #menu-btn { position: absolute; top: 10px; right: 10px; width: 50px; height: 50px; background: #e67e22; border-radius: 10px; border: 2px solid #fff; font-size: 24px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; box-shadow: 0 4px 0 #d35400; }
    #menu-btn:active { transform: translateY(4px); box-shadow: none; }
    
    .controls { position: absolute; bottom: 20px; right: 20px; pointer-events: auto; }
    #action-btn { width: 100px; height: 100px; background: #c0392b; border-radius: 50%; border: 5px solid #fff; display: flex; justify-content: center; align-items: center; font-size: 40px; box-shadow: 0 5px 0 #922b21; transition: background 0.2s; }
    #action-btn:active { transform: scale(0.95); box-shadow: none; }

    #joystick-zone { position: absolute; bottom: 30px; left: 180px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); pointer-events: auto; }
    #joystick-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; pointer-events: none; }

    /* MENUS */
    .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #2c3e50; width: 80%; height: 85%; border: 4px solid #fff; border-radius: 15px; display: none; z-index: 5000; padding: 20px; color: #fff; pointer-events: auto; box-shadow: 0 0 50px #000; overflow-y: auto; }
    .modal h2 { text-align: center; color: #f1c40f; margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; }
    .craft-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #444; }
    .btn { background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; border-bottom: 3px solid #1e8449; }
    .btn:active { border-bottom: 0; transform: translateY(3px); }
    .btn:disabled { background: #7f8c8d; border-bottom: 3px solid #555; opacity: 0.5; }
    .close-modal { width: 100%; background: #c0392b; border-bottom: 4px solid #922b21; padding: 15px; font-size: 18px; margin-top: 20px; }

    /* FLOATING TEXT */
    .float-txt { position: absolute; font-weight: bold; font-size: 20px; pointer-events: none; animation: float 1s forwards; text-shadow: 2px 2px 0 #000; z-index: 4000; }
    @keyframes float { to { transform: translateY(-50px); opacity: 0; } }

    /* SAVE NOTIF */
    #save-notif { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(39, 174, 96, 0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: none; }
</style>
</head>
<body>

<div id="rotate-msg"><h1>üì± TOURNEZ L'√âCRAN</h1><p>Jeu optimis√© pour le mode Paysage</p></div>

<canvas id="gameCanvas"></canvas>
<div id="night-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;background:blue;pointer-events:none;opacity:0;mix-blend-mode:multiply;z-index:10;"></div>

<div class="ui-layer">
    <div id="save-notif">üíæ Sauvegarde auto...</div>

    <div class="hud">
        <div class="hud-row" style="color:#e74c3c; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px;">
            <span>‚ù§Ô∏è VIE</span> <span id="hud-hp">100/100</span>
        </div>
        <div class="hud-row"><span>ü™µ Bois</span> <span id="hud-wood">0</span></div>
        <div class="hud-row"><span>ü™® Pierre</span> <span id="hud-stone">0</span></div>
        <div class="hud-row"><span>üåµ Cactus</span> <span id="hud-cactus">0</span></div>
        <div class="hud-row"><span>üü° Or</span> <span id="hud-gold">0</span></div>
        <div class="hud-row"><span>‚ö™ Fer</span> <span id="hud-iron">0</span></div>
        <div class="hud-row"><span>üíé Rubis</span> <span id="hud-ruby">0</span></div>
        <div class="hud-row"><span>‚ö´ Obsi</span> <span id="hud-obsi">0</span></div>
    </div>

    <div class="quest-box">
        <div class="quest-title">OBJECTIF ACTUEL</div>
        <div id="quest-txt">Chargement...</div>
    </div>

    <div id="menu-btn">üéí</div>

    <div class="minimap-container">
        <canvas id="miniCanvas" width="150" height="150"></canvas>
    </div>

    <div id="joystick-zone"><div id="joystick-stick"></div></div>
    <div class="controls"><div id="action-btn">‚öîÔ∏è</div></div>
</div>

<div id="craft-menu" class="modal">
    <h2>üõ†Ô∏è ARTISANAT & BASE</h2>
    
    <div class="craft-row" style="border-color:#f39c12; background:rgba(243,156,18,0.1);">
        <div><strong>üè† BASE / SOIN</strong><br><small id="house-desc">Construire (Soin passif)</small><br><span class="cost" id="house-cost">50 Bois</span></div>
        <button class="btn" id="btn-house" onclick="game.craft('house')">CONSTRUIRE</button>
    </div>

    <div class="craft-row" style="border-color:#3498db; background:rgba(52,152,219,0.1);">
        <div><strong>üõ°Ô∏è ARMURE</strong><br><small>+PV Max (N√©cessite Base)</small><br><span class="cost" id="armor-cost">...</span></div>
        <button class="btn" id="btn-armor" onclick="game.craft('armor')">FORGER</button>
    </div>
    
    <h3>OUTILS</h3>
    <div class="craft-row"><div>ü™ì <strong>HACHE</strong> <small id="axe-lvl">Niv 1</small><br><span class="cost" id="axe-cost">...</span></div><button class="btn" id="btn-axe" onclick="game.craft('axe')">UP</button></div>
    <div class="craft-row"><div>‚õèÔ∏è <strong>PIOCHE</strong> <small id="pick-lvl">Niv 1</small><br><span class="cost" id="pick-cost">...</span></div><button class="btn" id="btn-pick" onclick="game.craft('pick')">UP</button></div>
    <div class="craft-row"><div>‚öîÔ∏è <strong>√âP√âE</strong> <small id="sword-lvl">Niv 1</small><br><span class="cost" id="sword-cost">...</span></div><button class="btn" id="btn-sword" onclick="game.craft('sword')">UP</button></div>

    <button class="btn close-modal" onclick="document.getElementById('craft-menu').style.display='none'">RETOUR JEU</button>
</div>

<script>
/**
 * SURVIVAL RPG ULTIMATE - MOTEUR DE JEU
 */

// --- CONSTANTES & CONFIG ---
const WORLD_W = 4000;
const WORLD_H = 4000;
const CHUNK_SIZE = 1000; // 0-1000: Forest, 1000-2000: Desert, 2000-3000: Snow, 3000-4000: Volcano

const BIOMES = {
    FOREST: { start: 0, end: 1000, color: '#27ae60', ground: '#2ecc71' },
    DESERT: { start: 1000, end: 2000, color: '#e67e22', ground: '#f1c40f' },
    SNOW:   { start: 2000, end: 3000, color: '#bdc3c7', ground: '#ecf0f1' },
    VOLCANO:{ start: 3000, end: 4000, color: '#c0392b', ground: '#2c0505' }
};

const QUESTS = [
    { id: 0, txt: "R√©colter 10 BOIS", type: 'wood', target: 10 },
    { id: 1, txt: "Fabriquer une MAISON", type: 'house', target: 1 },
    { id: 2, txt: "R√©colter 10 PIERRES", type: 'stone', target: 10 },
    { id: 3, txt: "Am√©liorer la HACHE (Niv 2)", type: 'axe', target: 2 },
    { id: 4, txt: "Explorer le D√âSERT (Est)", type: 'explore_desert', target: 1 },
    { id: 5, txt: "Trouver 5 OR (D√©sert)", type: 'gold', target: 5 },
    { id: 6, txt: "Fabriquer une √âP√âE en Or (Niv 3)", type: 'sword', target: 3 },
    { id: 7, txt: "Explorer la NEIGE", type: 'explore_snow', target: 1 },
    { id: 8, txt: "Tuer 3 LOUPS Blancs", type: 'kill_wolf', target: 3 },
    { id: 9, txt: "Trouver 5 FER", type: 'iron', target: 5 },
    { id: 10, txt: "Explorer le VOLCAN (Fin)", type: 'explore_volcano', target: 1 },
    { id: 11, txt: "Trouver 3 OBSIDIENNE", type: 'obsi', target: 3 },
    { id: 12, txt: "Tuer le ROI D√âMON", type: 'kill_boss', target: 1 },
    { id: 13, txt: "VOUS √äTES LE MA√éTRE DE L'√éLE !", type: 'win', target: 0 }
];

// --- VARIABLES GLOBALES ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false }); // Opti
const miniCanvas = document.getElementById('miniCanvas');
const ctxMini = miniCanvas.getContext('2d');

let lastTime = 0;
let isGameRunning = true;
let saveTimer = 0;

// √âtat du jeu
let game = {
    player: { x: 500, y: 500, hp: 100, maxHp: 100, speed: 6, size: 24, angle: 0, iframes: 0 },
    inv: { wood:0, stone:0, cactus:0, gold:0, iron:0, ruby:0, obsi:0, axe:1, pick:1, sword:1, armor:0 },
    house: { active: false, x: 0, y: 0, lvl: 0, cooldown: 0 },
    quest: { id: 0, progress: 0 },
    dayTime: 0, // 0 to 1
    camera: { x:0, y:0 },
    objects: [],
    particles: []
};

// Input
let joy = { active:false, dx:0, dy:0, sx:0, sy:0 };

// --- INITIALISATION ---
function init() {
    resize();
    // Essayer de charger la save
    if(!loadGame()) {
        generateWorld();
    }
    requestAnimationFrame(loop);
    
    // Event Listeners
    setupInputs();
    
    // Fullscreen check
    document.body.addEventListener('touchstart', () => goFullscreen(), {once:true});
}

function generateWorld() {
    game.objects = [];
    
    // Helper spawn
    const spawn = (type, minX, maxX, count) => {
        for(let i=0; i<count; i++) {
            let x = minX + Math.random()*(maxX-minX);
            let y = Math.random()*WORLD_H;
            createObject(type, x, y);
        }
    };

    // 1. FOREST
    spawn('tree', 0, 1000, 120);
    spawn('stone', 0, 1000, 60);
    spawn('slime', 0, 1000, 20); // Mob facile
    
    // 2. DESERT
    spawn('cactus', 1000, 2000, 100); // Donne bois + vie
    spawn('gold_rock', 1000, 2000, 40);
    spawn('scorpion', 1000, 2000, 30); // Mob moyen
    
    // 3. SNOW
    spawn('iron_rock', 2000, 3000, 50);
    spawn('ice_spike', 2000, 3000, 80); // Decor
    spawn('wolf', 2000, 3000, 35); // Mob fort
    
    // 4. VOLCANO
    spawn('dead_tree', 3000, 4000, 60);
    spawn('ruby', 3000, 4000, 30);
    spawn('obsi', 3000, 4000, 20);
    spawn('demon', 3000, 4000, 25); // Mob tr√®s fort
    
    // BOSS FINAL
    createObject('boss', 3800, 2000);
    // Arene Boss
    for(let a=0; a<Math.PI*2; a+=0.5) createObject('wall', 3800+Math.cos(a)*400, 2000+Math.sin(a)*400);

    // Decor global
    for(let i=0; i<600; i++) createObject('grass', Math.random()*WORLD_W, Math.random()*WORLD_H);
}

function createObject(type, x, y) {
    let o = { type, x, y, hp:1, maxHp:1, size:30, emoji:'‚ùì', solid:false, hostile:false };
    
    // RESSOURCES
    if(type==='tree') { o.emoji='üå≤'; o.hp=15; o.maxHp=15; o.size=50; }
    if(type==='stone') { o.emoji='ü™®'; o.hp=25; o.maxHp=25; o.size=40; }
    if(type==='cactus') { o.emoji='üåµ'; o.hp=10; o.maxHp=10; o.size=40; }
    if(type==='gold_rock') { o.emoji='üü°'; o.hp=40; o.maxHp=40; o.size=35; }
    if(type==='iron_rock') { o.emoji='‚ö™'; o.hp=50; o.maxHp=50; o.size=35; }
    if(type==='ruby') { o.emoji='üíé'; o.hp=60; o.maxHp=60; o.size=30; }
    if(type==='obsi') { o.emoji='‚ö´'; o.hp=100; o.maxHp=100; o.size=40; }
    if(type==='dead_tree') { o.emoji='üçÇ'; o.hp=20; o.size=45; }
    if(type==='ice_spike') { o.emoji='üßä'; o.hp=30; o.size=30; }
    
    // MOBS
    if(type==='slime') { o.emoji='üü¢'; o.hp=30; o.maxHp=30; o.hostile=true; o.speed=2; o.dmg=5; }
    if(type==='scorpion') { o.emoji='ü¶Ç'; o.hp=60; o.maxHp=60; o.hostile=true; o.speed=4; o.dmg=10; }
    if(type==='wolf') { o.emoji='üê∫'; o.hp=100; o.maxHp=100; o.hostile=true; o.speed=5; o.dmg=15; }
    if(type==='demon') { o.emoji='üëø'; o.hp=150; o.maxHp=150; o.hostile=true; o.speed=3.5; o.dmg=25; }
    if(type==='boss') { o.emoji='üëπ'; o.hp=1000; o.maxHp=1000; o.hostile=true; o.speed=4.5; o.dmg=40; o.size=100; o.isBoss=true; }

    // OTHER
    if(type==='grass') { o.emoji=['üå±','üåø','üåº'][Math.floor(Math.random()*3)]; o.size=20; }
    if(type==='wall') { o.emoji='üß±'; o.hp=9999; o.solid=true; }
    
    game.objects.push(o);
}

// --- GAME LOOP ---
function loop(time) {
    let dt = time - lastTime;
    lastTime = time;

    update(dt);
    draw();
    updateUI();
    
    // Save auto toutes les 10s
    saveTimer += dt;
    if(saveTimer > 10000) { saveGame(); saveTimer = 0; }

    if(isGameRunning) requestAnimationFrame(loop);
}

function update(dt) {
    // 1. PLAYER MOVE
    if(joy.active) {
        let nx = game.player.x + Math.cos(game.player.angle) * game.player.speed;
        let ny = game.player.y + Math.sin(game.player.angle) * game.player.speed;
        
        // Collision Map
        nx = Math.max(0, Math.min(WORLD_W, nx));
        ny = Math.max(0, Math.min(WORLD_H, ny));

        // Collision Objets Solides
        let collide = false;
        for(let o of game.objects) {
            if(o.solid && Math.hypot(nx-o.x, ny-o.y) < game.player.size + o.size/2) collide = true;
        }
        if(!collide) { game.player.x = nx; game.player.y = ny; }
        
        // Check Biome Discovery Quests
        if(nx > 1000 && nx < 2000) checkQuest('explore_desert', 1);
        if(nx > 2000 && nx < 3000) checkQuest('explore_snow', 1);
        if(nx > 3000) checkQuest('explore_volcano', 1);
    }

    // 2. CAMERA
    game.camera.x = game.player.x - canvas.width/2;
    game.camera.y = game.player.y - canvas.height/2;

    // 3. ENTITIES & MOBS
    if(game.player.iframes > 0) game.player.iframes--;

    game.objects.forEach(o => {
        if(o.hostile && o.hp > 0) {
            let dist = Math.hypot(game.player.x - o.x, game.player.y - o.y);
            if(dist < 400) { // Aggro range
                o.x += (game.player.x - o.x) / dist * o.speed;
                o.y += (game.player.y - o.y) / dist * o.speed;
                
                // Attack
                if(dist < game.player.size + o.size/2 && game.player.iframes <= 0) {
                    game.player.hp -= o.dmg;
                    game.player.iframes = 40;
                    createFloatText(`-${o.dmg}`, game.player.x, game.player.y, 'red');
                    screenShake();
                    if(game.player.hp <= 0) {
                        alert("‚ò†Ô∏è VOUS √äTES MORT !\nRechargement...");
                        localStorage.removeItem('rpg_save_v7');
                        location.reload();
                    }
                }
            }
        }
    });

    // 4. HOUSE HEALING
    if(game.house.active) {
        let dist = Math.hypot(game.player.x - game.house.x, game.player.y - game.house.y);
        if(dist < 100) {
            game.house.cooldown++;
            if(game.house.cooldown > (60 - game.house.lvl*10) && game.player.hp < game.player.maxHp) {
                game.player.hp += 2;
                game.house.cooldown = 0;
                createFloatText("üíö", game.player.x, game.player.y-30, '#2ecc71');
            }
        }
    }

    // 5. CYCLE JOUR / NUIT
    game.dayTime += 0.0005; // Vitesse du temps
    if(game.dayTime > 1) game.dayTime = 0;
}

function draw() {
    // CLEAR
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(-game.camera.x, -game.camera.y);

    // --- DRAW GROUND (Optimis√©: Gros rectangles par biome) ---
    ctx.fillStyle = BIOMES.FOREST.ground; ctx.fillRect(0, 0, 1000, WORLD_H);
    ctx.fillStyle = BIOMES.DESERT.ground; ctx.fillRect(1000, 0, 1000, WORLD_H);
    ctx.fillStyle = BIOMES.SNOW.ground; ctx.fillRect(2000, 0, 1000, WORLD_H);
    ctx.fillStyle = BIOMES.VOLCANO.ground; ctx.fillRect(3000, 0, 1000, WORLD_H);

    // --- DRAW OBJECTS ---
    // Simple Z-sort
    game.objects.sort((a,b) => a.y - b.y);
    
    // Viewport culling
    let viewX = game.camera.x, viewY = game.camera.y;
    let viewW = canvas.width, viewH = canvas.height;

    for(let o of game.objects) {
        if(o.x + o.size < viewX || o.x - o.size > viewX + viewW || 
           o.y + o.size < viewY || o.y - o.size > viewY + viewH) continue;

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(o.x, o.y+o.size/3, o.size/1.2, o.size/3, 0, 0, Math.PI*2);
        ctx.fill();

        // Emoji Draw
        let shake = (o.hitAnim > 0) ? Math.random()*10-5 : 0;
        if(o.hitAnim) o.hitAnim--;
        
        ctx.font = `${o.size}px Segoe UI Emoji, Arial`;
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        
        // Solid backdrop for opacity
        /*ctx.fillStyle = 'rgba(255,255,255,0.2)'; 
        ctx.beginPath(); ctx.arc(o.x+shake, o.y, o.size/2.2, 0, Math.PI*2); ctx.fill();*/
        
        ctx.fillText(o.emoji, o.x + shake, o.y);

        // Health Bar
        if((o.hp < o.maxHp || o.isBoss) && o.type !== 'grass') {
            let w = 40; if(o.isBoss) w=100;
            let pct = o.hp / o.maxHp;
            ctx.fillStyle = 'black'; ctx.fillRect(o.x-w/2, o.y-o.size, w, 6);
            ctx.fillStyle = 'red'; ctx.fillRect(o.x-w/2, o.y-o.size, w*pct, 6);
        }
    }

    // --- DRAW HOUSE ---
    if(game.house.active) {
        let hSize = 100 + game.house.lvl*30;
        let hEmoji = ["‚õ∫","üè†","üè∞"][game.house.lvl-1];
        
        // Safe zone circle
        ctx.strokeStyle = '#2ecc71'; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(game.house.x, game.house.y, 100, 0, Math.PI*2); ctx.stroke();
        
        ctx.font = `${hSize}px Segoe UI Emoji`;
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(hEmoji, game.house.x, game.house.y);
    }

    // --- DRAW PLAYER ---
    ctx.translate(game.player.x, game.player.y);
    if(game.player.iframes % 4 < 2) {
        // Armor Shield
        if(game.inv.armor > 0) {
            ctx.save();
            ctx.rotate(Date.now()/400);
            ctx.font = "20px Arial"; ctx.fillText("üõ°Ô∏è", 35, 0); ctx.fillText("üõ°Ô∏è", -35, 0);
            ctx.restore();
        }
        
        ctx.font = "40px Segoe UI Emoji";
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText("ü§†", 0, 0);
    }
    ctx.translate(-game.player.x, -game.player.y);

    // --- PARTICLES ---
    for(let i=game.particles.length-1; i>=0; i--) {
        let p = game.particles[i];
        p.y -= 1; p.life--;
        ctx.globalAlpha = p.life/40;
        ctx.font = "bold 20px Arial";
        ctx.fillStyle = p.col;
        ctx.strokeStyle = "black"; ctx.lineWidth = 2;
        ctx.strokeText(p.txt, p.x, p.y);
        ctx.fillText(p.txt, p.x, p.y);
        if(p.life <= 0) game.particles.splice(i, 1);
    }
    ctx.globalAlpha = 1;

    ctx.restore();

    // --- NIGHT OVERLAY ---
    // Sin wave pour jour/nuit (0.5 = midi, 0 ou 1 = minuit)
    let darkness = 0;
    if(game.dayTime > 0.7 || game.dayTime < 0.2) darkness = 0.6; // Nuit
    document.getElementById('night-overlay').style.opacity = darkness;

    // --- DRAW MINI-MAP ---
    drawMiniMap();
}

function drawMiniMap() {
    ctxMini.clearRect(0,0,150,150);
    let scale = 150 / WORLD_W;
    
    // Backgrounds
    ctxMini.fillStyle = BIOMES.FOREST.color; ctxMini.fillRect(0,0,1000*scale, 150);
    ctxMini.fillStyle = BIOMES.DESERT.color; ctxMini.fillRect(1000*scale,0,1000*scale, 150);
    ctxMini.fillStyle = BIOMES.SNOW.color; ctxMini.fillRect(2000*scale,0,1000*scale, 150);
    ctxMini.fillStyle = BIOMES.VOLCANO.color; ctxMini.fillRect(3000*scale,0,1000*scale, 150);

    // House
    if(game.house.active) {
        ctxMini.fillStyle = 'lime';
        ctxMini.fillRect(game.house.x*scale-2, game.house.y*scale-2, 4, 4);
    }

    // Player
    ctxMini.fillStyle = 'red';
    ctxMini.beginPath(); ctxMini.arc(game.player.x*scale, game.player.y*scale, 3, 0, Math.PI*2); ctxMini.fill();
    ctxMini.strokeStyle = 'white'; ctxMini.stroke();
}

// --- ACTIONS & QUESTS ---

function handleAction() {
    let t = getNearestTarget();
    if(!t) return;

    // D√©g√¢ts
    let dmg = 1;
    if(t.hostile) dmg = game.inv.sword * 6; // 6, 12, 18...
    else if(t.type.includes('tree') || t.type === 'cactus') dmg = game.inv.axe * 3;
    else dmg = game.inv.pick * 3;

    t.hp -= dmg;
    t.hitAnim = 5;
    createFloatText("üí•", t.x, t.y, '#fff');

    if(t.hp <= 0) {
        // Loot Logic
        let lootAmt = 0;
        if(t.type === 'tree') { game.inv.wood += 5; checkQuest('wood', 5); createFloatText("+5 BOIS", t.x, t.y, '#2ecc71'); }
        if(t.type === 'stone') { game.inv.stone += 3; checkQuest('stone', 3); createFloatText("+3 PIERRE", t.x, t.y, '#95a5a6'); }
        if(t.type === 'cactus') { game.inv.wood += 2; game.inv.cactus++; game.player.hp = Math.min(game.player.maxHp, game.player.hp+5); createFloatText("+2 BOIS / +VIE", t.x, t.y, 'lime'); }
        if(t.type === 'gold_rock') { game.inv.gold += 2; checkQuest('gold', 2); createFloatText("+2 OR", t.x, t.y, 'gold'); }
        if(t.type === 'iron_rock') { game.inv.iron += 2; checkQuest('iron', 2); createFloatText("+2 FER", t.x, t.y, '#fff'); }
        if(t.type === 'ruby') { game.inv.ruby += 1; createFloatText("+1 RUBIS", t.x, t.y, '#e91e63'); }
        if(t.type === 'obsi') { game.inv.obsi += 1; checkQuest('obsi', 1); createFloatText("+1 OBSIDIENNE", t.x, t.y, '#000'); }
        
        // Kill Quests
        if(t.type === 'wolf') checkQuest('kill_wolf', 1);
        if(t.type === 'boss') checkQuest('kill_boss', 1);

        // Remove
        game.objects.splice(game.objects.indexOf(t), 1);
    }
}

function getNearestTarget() {
    let closest = null, minDist = 120;
    for(let o of game.objects) {
        if(o.type === 'grass' || o.type === 'wall' || o.type === 'ice_spike') continue;
        let d = Math.hypot(game.player.x - o.x, game.player.y - o.y);
        if(d < minDist) { minDist = d; closest = o; }
    }
    return closest;
}

function checkQuest(type, amount) {
    let q = QUESTS[game.quest.id];
    if(!q) return; // Fini
    if(q.type === type) {
        game.quest.progress += amount;
        if(game.quest.progress >= q.target) {
            createFloatText("üèÜ QU√äTE TERMIN√âE !", game.player.x, game.player.y - 50, 'gold');
            game.quest.id++;
            game.quest.progress = 0;
            saveGame();
        }
    }
}

// --- CRAFTING SYSTEM ---
game.craft = function(item) {
    let msg = "";
    // HOUSE
    if(item === 'house') {
        let costs = [{w:50},{w:150},{w:300}];
        if(game.house.lvl >= 3) return;
        let c = costs[game.house.lvl];
        if(game.inv.wood >= c.w) {
            game.inv.wood -= c.w;
            if(game.house.lvl === 0) { game.house.active = true; game.house.x = game.player.x; game.house.y = game.player.y; checkQuest('house', 1); }
            game.house.lvl++;
            msg = "MAISON AM√âLIOR√âE";
        }
    }
    // ARMOR
    if(item === 'armor') {
        if(!game.house.active) return; // Secu
        let costs = [{s:50,w:50},{s:100,i:10},{s:200,ob:5}];
        if(game.inv.armor >= 3) return;
        let c = costs[game.inv.armor];
        // Check inv... (simplifi√© pour la d√©mo, a faire proprement)
        let ok = false;
        if(game.inv.armor==0 && game.inv.stone>=c.s && game.inv.wood>=c.w) { game.inv.stone-=c.s; game.inv.wood-=c.w; ok=true; }
        if(game.inv.armor==1 && game.inv.stone>=c.s && game.inv.iron>=c.i) { game.inv.stone-=c.s; game.inv.iron-=c.i; ok=true; }
        
        if(ok) {
            game.inv.armor++;
            game.player.maxHp += 100; game.player.hp = game.player.maxHp;
            msg = "ARMURE √âQUIP√âE";
        }
    }
    // TOOLS (Simplifi√©)
    if(item === 'axe' && game.inv.wood >= game.inv.axe*20) { game.inv.wood -= game.inv.axe*20; game.inv.axe++; checkQuest('axe', 1); msg="HACHE UP !"; }
    if(item === 'pick' && game.inv.wood >= 20 && game.inv.stone >= 20) { game.inv.wood-=20; game.inv.stone-=20; game.inv.pick++; msg="PIOCHE UP !"; }
    if(item === 'sword' && game.inv.wood >= 50 && game.inv.gold >= game.inv.sword*5) { game.inv.wood-=50; game.inv.gold-=game.inv.sword*5; game.inv.sword++; checkQuest('sword', 1); msg="√âP√âE UP !"; }

    if(msg) { createFloatText(msg, game.player.x, game.player.y, '#fff'); updateUI(); }
};

// --- UI UPDATE ---
function updateUI() {
    document.getElementById('hud-hp').innerText = Math.floor(game.player.hp) + "/" + game.player.maxHp;
    document.getElementById('hud-wood').innerText = game.inv.wood;
    document.getElementById('hud-stone').innerText = game.inv.stone;
    document.getElementById('hud-cactus').innerText = game.inv.cactus;
    document.getElementById('hud-gold').innerText = game.inv.gold;
    document.getElementById('hud-iron').innerText = game.inv.iron;
    document.getElementById('hud-ruby').innerText = game.inv.ruby;
    document.getElementById('hud-obsi').innerText = game.inv.obsi;

    // Quest
    let q = QUESTS[game.quest.id];
    document.getElementById('quest-txt').innerText = q ? `${q.txt} (${game.quest.progress}/${q.target})` : "TOUTES QU√äTES FINIES !";

    // Action Button Icon
    let btn = document.getElementById('action-btn');
    let t = getNearestTarget();
    if(t) {
        if(t.hostile) { btn.innerText = "üó°Ô∏è"; btn.style.background = "#c0392b"; }
        else if(t.type.includes('tree') || t.type==='cactus') { btn.innerText = "ü™ì"; btn.style.background = "#e67e22"; }
        else { btn.innerText = "‚õèÔ∏è"; btn.style.background = "#7f8c8d"; }
    } else {
        btn.innerText = "‚öîÔ∏è"; btn.style.background = "#95a5a6";
    }

    // Menu Texts (Dynamique)
    document.getElementById('axe-cost').innerText = (game.inv.axe*20) + " Bois";
    document.getElementById('sword-cost').innerText = "50 Bois / " + (game.inv.sword*5) + " Or";
    
    let armorC = ["50 P / 50 B", "100 P / 10 Fer", "200 P / 5 Obsi"][game.inv.armor] || "MAX";
    document.getElementById('armor-cost').innerText = armorC;
}

function createFloatText(txt, x, y, col) {
    game.particles.push({txt, x, y, col, life:40});
}

function screenShake() {
    canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
    setTimeout(()=>canvas.style.transform='none', 200);
}

// --- INPUTS ---
function setupInputs() {
    const joyZone = document.getElementById('joystick-zone');
    const stick = document.getElementById('joystick-stick');
    const actionBtn = document.getElementById('action-btn');
    const menuBtn = document.getElementById('menu-btn');

    // Joystick Touch
    joyZone.addEventListener('touchstart', e => {
        joy.active = true;
        joy.sx = e.touches[0].clientX; joy.sy = e.touches[0].clientY;
    }, {passive:false});
    
    joyZone.addEventListener('touchmove', e => {
        e.preventDefault();
        if(!joy.active) return;
        let cx = e.touches[0].clientX, cy = e.touches[0].clientY;
        let dx = cx - joy.sx, dy = cy - joy.sy;
        let dist = Math.min(50, Math.hypot(dx, dy));
        let angle = Math.atan2(dy, dx);
        stick.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        game.player.angle = angle;
        game.player.moving = true;
    }, {passive:false});

    const endJoy = () => { joy.active = false; stick.style.transform = 'translate(0,0)'; };
    joyZone.addEventListener('touchend', endJoy);
    
    // Mouse Fallback for PC testing
    joyZone.addEventListener('mousedown', e=>{ joy.active=true; joy.sx=e.clientX; joy.sy=e.clientY; });
    window.addEventListener('mousemove', e=>{ 
        if(joy.active) {
            let dx=e.clientX-joy.sx, dy=e.clientY-joy.sy;
            game.player.angle = Math.atan2(dy, dx);
            stick.style.transform = `translate(${Math.min(50,dx)}px, ${Math.min(50,dy)}px)`;
        }
    });
    window.addEventListener('mouseup', endJoy);

    // Buttons
    actionBtn.addEventListener('touchstart', e=>{ e.preventDefault(); handleAction(); });
    actionBtn.addEventListener('mousedown', e=>{ e.preventDefault(); handleAction(); });
    
    menuBtn.addEventListener('click', () => {
        document.getElementById('craft-menu').style.display = 'block';
        updateUI();
    });
}

// --- SAVE SYSTEM ---
function saveGame() {
    const data = {
        p: {x:game.player.x, y:game.player.y, hp:game.player.hp, max:game.player.maxHp},
        inv: game.inv,
        house: game.house,
        quest: game.quest,
        objs: game.objects.filter(o => o.type==='wall' || (o.isBoss && o.hp<o.maxHp)) // Save walls & boss progress only to save space
    };
    localStorage.setItem('rpg_save_v7', JSON.stringify(data));
    
    let notif = document.getElementById('save-notif');
    notif.style.display = 'block';
    setTimeout(() => notif.style.display='none', 2000);
}

function loadGame() {
    const raw = localStorage.getItem('rpg_save_v7');
    if(!raw) return false;
    try {
        const d = JSON.parse(raw);
        game.player.x = d.p.x; game.player.y = d.p.y; game.player.hp = d.p.hp; game.player.maxHp = d.p.max;
        game.inv = d.inv;
        game.house = d.house;
        game.quest = d.quest;
        
        // Regen world but keep walls/boss status
        generateWorld(); 
        // Remove boss if already dead in save ? (Complex logic skipped for demo stability)
        return true;
    } catch(e) { console.error("Save corrupt"); return false; }
}

function resize() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    document.getElementById('rotate-msg').style.display = (window.innerHeight > window.innerWidth) ? 'flex' : 'none';
}
function goFullscreen() { document.documentElement.requestFullscreen?.(); }
window.addEventListener('resize', resize);

// START
init();

</script>
</body>
</html>